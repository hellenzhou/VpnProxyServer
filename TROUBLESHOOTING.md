# VPN TCP è¿æ¥æ•…éšœæ’æŸ¥æŒ‡å—

## ğŸ¯ å¿«é€Ÿè¯Šæ–­

### ç—‡çŠ¶æ£€æŸ¥è¡¨

| ç—‡çŠ¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| DNS (UDP) æŸ¥è¯¢æˆåŠŸ | âœ… | è¡¨æ˜ UDP è½¬å‘å·¥ä½œæ­£å¸¸ |
| TCP SYN åŒ…å‘é€æˆåŠŸ | âœ… | è¡¨æ˜å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯é€šä¿¡æ­£å¸¸ |
| TCP è¿æ¥å»ºç«‹å¤±è´¥ | âŒ | **é—®é¢˜åœ¨è¿™é‡Œ** |
| select() è¶…æ—¶è¿”å› 0 | âŒ | æ²¡æœ‰æ”¶åˆ°ä»»ä½•å“åº” |
| ç½‘ç»œè¯Šæ–­å…¨éƒ¨å¤±è´¥ | âŒ | æ‰€æœ‰å¤–éƒ¨ TCP è¿æ¥éƒ½å¤±è´¥ |

### é—®é¢˜å®šä½

å¦‚æœä½ çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—æ¨¡å¼ï¼š

```log
âœ… UDP socket created successfully
âœ… UDP DNSæµ‹è¯•æˆåŠŸ
âŒ TCP connection timeout (select returned 0)
âŒ æ‰€æœ‰ TCP æµ‹è¯•å¤±è´¥ï¼ˆç™¾åº¦/è…¾è®¯/æ·˜å®ç­‰ï¼‰
```

**99% çš„å¯èƒ½æ€§æ˜¯ï¼šVPN è·¯ç”±å¾ªç¯é—®é¢˜**

## ğŸ” æ ¹å› åˆ†æ

### é—®é¢˜æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPN Client  â”‚ (å¯åŠ¨VPNï¼Œé…ç½®è·¯ç”±è¡¨)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ æ‰€æœ‰æµé‡èµ°VPNè·¯ç”±
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPN Proxy Server     â”‚ (éœ€è¦è¿æ¥çœŸå®æœåŠ¡å™¨)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ å°è¯•è¿æ¥ baidu.com
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç³»ç»Ÿè·¯ç”±è¡¨           â”‚ (æ£€æŸ¥ï¼šè°åº”è¯¥å¤„ç†è¿™ä¸ªè¿æ¥ï¼Ÿ)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ âŒ é—®é¢˜ï¼šProxy Server ä¸åœ¨ trustedApplications
       â”‚    æ‰€ä»¥å®ƒçš„æµé‡ä¹Ÿèµ° VPN è·¯ç”±
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPN è·¯ç”±             â”‚ (å‘ç°ï¼šè¿™æ˜¯ç»™ VPN çš„æµé‡)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ å°†æµé‡å‘é€å› VPN Client
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPN Client           â”‚ (åˆæ”¶åˆ°äº†è¿æ¥è¯·æ±‚...)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ è½¬å‘ç»™ Proxy Server
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPN Proxy Server     â”‚ (åˆå°è¯•è¿æ¥çœŸå®æœåŠ¡å™¨...)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚
       â–¼
   â™»ï¸  è·¯ç”±å¾ªç¯ï¼
       â”‚
       â–¼
   â±ï¸  è¶…æ—¶å¤±è´¥
```

### ä¿®å¤åçš„æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPN Client  â”‚ (é…ç½® trustedApplications)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ æ­£å¸¸æµé‡èµ°VPN
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPN Proxy Server     â”‚ (åœ¨ä¿¡ä»»åˆ—è¡¨ä¸­)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ å°è¯•è¿æ¥ baidu.com
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç³»ç»Ÿè·¯ç”±è¡¨           â”‚ (æ£€æŸ¥ä¿¡ä»»åˆ—è¡¨)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ âœ… Proxy Server åœ¨ trustedApplications
       â”‚    å®ƒçš„æµé‡ç›´æ¥èµ°ç‰©ç†ç½‘ç»œ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çœŸå®ç½‘ç»œæ¥å£         â”‚ (WiFi/ä»¥å¤ªç½‘)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ ç›´æ¥è¿æ¥
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ baidu.com            â”‚ âœ… è¿æ¥æˆåŠŸï¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› ï¸ ä¿®å¤æ­¥éª¤è¯¦è§£

### æ­¥éª¤ 1: æ£€æŸ¥å½“å‰é…ç½®

**æ–‡ä»¶**: `VpnClient/entry/src/main/ets/vpnability/VPNExtentionAbility.ets`

```typescript
// æŸ¥æ‰¾è¿™ä¸€æ®µä»£ç ï¼ˆçº¦åœ¨ 275 è¡Œé™„è¿‘ï¼‰
class Config {
  public trustedApplications: string[];
  
  constructor(tunIp: string, blockedAppName: string) {
    // ...
    this.trustedApplications = [];  // âŒ è¿™é‡Œæ˜¯ç©ºçš„ï¼
  }
}
```

### æ­¥éª¤ 2: åº”ç”¨ä¿®å¤

**ä¿®æ”¹ä¸º**:

```typescript
class Config {
  public trustedApplications: string[];
  
  constructor(tunIp: string, blockedAppName: string) {
    // ...
    // âš ï¸ é‡è¦ï¼šå°†VPN Proxy Serveræ·»åŠ åˆ°ä¿¡ä»»åˆ—è¡¨
    this.trustedApplications = ['com.hellen.vpnserver'];  // âœ… ä¿®å¤ï¼
  }
}
```

### æ­¥éª¤ 3: åŒæ ·ä¿®æ”¹è®¾ç½®é¡µé¢

**æ–‡ä»¶**: `VpnClient/entry/src/main/ets/pages/SetupVpn.ets`

æ‰¾åˆ°å¹¶ä¿®æ”¹ç›¸åŒçš„ä½ç½®ï¼ˆçº¦åœ¨ 129 è¡Œï¼‰ã€‚

### æ­¥éª¤ 4: éªŒè¯ Bundle åç§°

ç¡®è®¤ Proxy Server çš„ bundle åç§°æ­£ç¡®ï¼š

**æ–‡ä»¶**: `VpnProxyServer/AppScope/app.json5`

```json
{
  "app": {
    "bundleName": "com.hellen.vpnserver",  // âœ… ç¡®è®¤è¿™ä¸ªåç§°
    ...
  }
}
```

### æ­¥éª¤ 5: å®Œå…¨é‡æ–°éƒ¨ç½²

```bash
# 1. æ¸…ç† VPN Client
cd VpnClient
hvigorw clean

# 2. é‡æ–°æ„å»º
hvigorw assembleHap

# 3. å¸è½½æ—§ç‰ˆæœ¬ï¼ˆé‡è¦ï¼ï¼‰
hdc uninstall com.samples.vpncontrol_case

# 4. å®‰è£…æ–°ç‰ˆæœ¬
hdc install entry-default-signed.hap

# 5. é‡å¯ VPN Proxy Serverï¼ˆç¡®ä¿å®ƒåœ¨è¿è¡Œï¼‰
# ï¼ˆåœ¨è®¾å¤‡ä¸Šæ‰‹åŠ¨æ“ä½œï¼‰

# 6. é‡æ–°å¯åŠ¨ VPN Client
# ï¼ˆåœ¨è®¾å¤‡ä¸Šæ‰‹åŠ¨æ“ä½œï¼‰
```

## ğŸ”¬ éªŒè¯ä¿®å¤

### é¢„æœŸæ—¥å¿—è¾“å‡º

**ä¿®å¤å‰**:
```log
ğŸ”— Testing TCP connectivity to 110.242.68.66:80
â³ TCPè¿æ¥è¿›è¡Œä¸­ (EINPROGRESS)ï¼Œç­‰å¾…è¿æ¥å®Œæˆ...
ğŸ” [ç½‘ç»œè¯Šæ–­] select()è¿”å›: 0
âŒ TCP connection timeout
```

**ä¿®å¤å**:
```log
ğŸ”— Testing TCP connectivity to 110.242.68.66:80
â³ TCPè¿æ¥è¿›è¡Œä¸­ (EINPROGRESS)ï¼Œç­‰å¾…è¿æ¥å®Œæˆ...
ğŸ” [ç½‘ç»œè¯Šæ–­] select()è¿”å›: 1
ğŸ” getsockopt(SO_ERROR): 0 (No error information)
âœ…âœ…âœ… TCP connection established successfully âœ…âœ…âœ…
```

### ç½‘ç»œè¯Šæ–­è¾“å‡º

**ä¿®å¤å‰**:
```log
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸ“Š ç½‘ç»œè¯Šæ–­æµ‹è¯•ç»“æœ                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘   æˆåŠŸ: 0/6 é¡¹æµ‹è¯•é€šè¿‡                                 â•‘
â•‘   çŠ¶æ€: âŒ ç½‘ç»œå®Œå…¨ä¸å¯ç”¨                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**ä¿®å¤å**:
```log
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸ“Š ç½‘ç»œè¯Šæ–­æµ‹è¯•ç»“æœ                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘   æˆåŠŸ: 5/6 é¡¹æµ‹è¯•é€šè¿‡                                 â•‘
â•‘   çŠ¶æ€: âœ… ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## ğŸ› æ•…éšœæ’æŸ¥æ¸…å•

å¦‚æœä¿®å¤åä»ç„¶å¤±è´¥ï¼Œä¾æ¬¡æ£€æŸ¥ï¼š

### âœ… 1. ç¡®è®¤ä¿®æ”¹å·²ç”Ÿæ•ˆ

```bash
# æ£€æŸ¥ APK æ˜¯å¦æ˜¯æ–°ç¼–è¯‘çš„
hdc shell dumpsys package com.samples.vpncontrol_case | grep versionCode
# åº”è¯¥çœ‹åˆ°ç‰ˆæœ¬å·å¢åŠ äº†ï¼ˆå¦‚æœä½ æ”¹äº† versionCodeï¼‰
```

### âœ… 2. ç¡®è®¤ VPN å·²é‡å¯

- VPN ä¸èƒ½åªæ˜¯"åœæ­¢å†å¯åŠ¨"
- å¿…é¡»å®Œå…¨é€€å‡º VPN Client åº”ç”¨ï¼Œç„¶åé‡æ–°æ‰“å¼€

### âœ… 3. ç¡®è®¤ Proxy Server æ­£åœ¨è¿è¡Œ

```bash
# æŸ¥çœ‹ Proxy Server æ—¥å¿—
hdc shell hilog | grep "VpnServer"

# åº”è¯¥çœ‹åˆ°ï¼š
# "Starting VPN Server on port 8888"
# "Socket bound successfully"
```

### âœ… 4. ç¡®è®¤è®¾å¤‡æœ‰ç½‘ç»œ

```bash
# æµ‹è¯•è®¾å¤‡çš„åŸºç¡€ç½‘ç»œè¿æ¥
hdc shell ping -c 3 baidu.com

# åº”è¯¥èƒ½ ping é€š
```

### âœ… 5. æ£€æŸ¥é˜²ç«å¢™

æŸäº›ä¼ä¸šç½‘ç»œæˆ–é˜²ç«å¢™å¯èƒ½é˜»æ­¢äº†ï¼š
- TCP å‡ºç«™è¿æ¥
- ç‰¹å®šç«¯å£ï¼ˆ80, 443ï¼‰
- ç‰¹å®š IP åœ°å€

### âœ… 6. æŸ¥çœ‹å®Œæ•´æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰ç›¸å…³æ—¥å¿—
hdc shell hilog | grep -E "VpnServer|ZBQ|testTag"

# å¯»æ‰¾ï¼š
# - "trustedApplications" ç›¸å…³æ¶ˆæ¯
# - TCP è¿æ¥é”™è¯¯
# - Socket åˆ›å»ºå¤±è´¥
```

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œæ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **å®Œæ•´æ—¥å¿—è¾“å‡º**
   ```bash
   hdc shell hilog > vpn_logs.txt
   ```

2. **VPN é…ç½®**
   - `VPNExtentionAbility.ets` ä¸­çš„ trustedApplications å€¼
   - Bundle åç§°

3. **ç½‘ç»œç¯å¢ƒ**
   - è®¾å¤‡æ˜¯å¦è¿æ¥åˆ°äº’è”ç½‘
   - æ˜¯å¦åœ¨ä¼ä¸šç½‘ç»œ/å—é™ç½‘ç»œä¸­
   - é˜²ç«å¢™è®¾ç½®

4. **ç‰ˆæœ¬ä¿¡æ¯**
   - HarmonyOS ç‰ˆæœ¬
   - DevEco Studio ç‰ˆæœ¬
   - VPN Client/Server ç‰ˆæœ¬

---

**æœ€åæ›´æ–°**: 2026-01-14
