# VPN Proxy Server - 迁移计划

## 📋 总览

**目标**：从旧架构平滑迁移到新架构，确保系统稳定性

**时间估计**：4-6 周

**风险等级**：中等

---

## 🗓️ 分阶段迁移

### 阶段 1：基础设施准备（第 1 周）

#### 目标
- 搭建新架构的基础框架
- 确保编译通过
- 建立测试环境

#### 任务清单

- [ ] **1.1 创建新目录结构**
  ```bash
  VpnProxyServer/
  ├── 新架构/          # 新代码
  ├── entry/           # 旧代码（保留）
  └── 迁移文档/
  ```

- [ ] **1.2 配置构建系统**
  - 更新 CMakeLists.txt
  - 添加新的依赖（Boost.Asio 或 libuv）
  - 配置 C++17/20 编译选项

- [ ] **1.3 实现核心基础类**
  - [x] Config 类（配置管理）
  - [x] Logger 类（日志系统）
  - [x] Error 类（错误处理）
  - [ ] ThreadPool 类（线程池）

- [ ] **1.4 建立测试框架**
  - 集成 Google Test
  - 编写第一个单元测试
  - 配置 CI/CD 管道

**验收标准**：
- ✅ 新代码能够编译
- ✅ 所有基础类有单元测试
- ✅ 测试覆盖率 > 80%

---

### 阶段 2：网络层实现（第 2 周）

#### 目标
- 实现事件驱动的网络层
- 完成 UDP socket 封装
- 验证基本收发功能

#### 任务清单

- [ ] **2.1 事件循环**
  - [ ] 实现 EventLoop 类（epoll）
  - [ ] 添加定时器支持
  - [ ] 编写事件循环测试

- [ ] **2.2 Socket 封装**
  - [ ] UdpSocket 类
  - [ ] SocketAddress 类
  - [ ] AsyncReceiver 类
  - [ ] AsyncSender 类

- [ ] **2.3 集成测试**
  - [ ] 测试收发 UDP 包
  - [ ] 测试高并发场景
  - [ ] 性能基准测试

**验收标准**：
- ✅ 能够异步收发 UDP 包
- ✅ 并发性能达到 10,000 pps
- ✅ 无内存泄漏

---

### 阶段 3：数据包处理层（第 3 周）

#### 目标
- 实现数据包解析和构建
- 支持 IPv4/IPv6
- 验证数据包正确性

#### 任务清单

- [ ] **3.1 数据包解析**
  - [ ] PacketView 类（零拷贝）
  - [ ] PacketParser 类
  - [ ] 协议识别（TCP/UDP/ICMP）

- [ ] **3.2 数据包构建**
  - [ ] PacketBuilder 类
  - [ ] 校验和计算
  - [ ] 响应包构建

- [ ] **3.3 验证**
  - [ ] 使用 Wireshark 验证
  - [ ] 解析各种格式的包
  - [ ] 边界情况测试

**验收标准**：
- ✅ 正确解析 IPv4/IPv6 包
- ✅ 正确计算校验和
- ✅ 通过 Wireshark 验证

---

### 阶段 4：转发层实现（第 4 周）

#### 目标
- 实现 NAT 表
- 实现转发逻辑
- 完成端到端功能

#### 任务清单

- [ ] **4.1 NAT 表**
  - [ ] 分段锁设计
  - [ ] 会话管理
  - [ ] 自动清理

- [ ] **4.2 转发器**
  - [ ] Forwarder 类
  - [ ] UDP 转发
  - [ ] TCP 转发（如果启用）

- [ ] **4.3 DNS 缓存**
  - [ ] DNSCache 类
  - [ ] TTL 管理
  - [ ] 缓存统计

**验收标准**：
- ✅ NAT 表并发性能 > 100,000 ops/s
- ✅ 端到端转发成功
- ✅ DNS 缓存命中率 > 80%

---

### 阶段 5：集成和测试（第 5 周）

#### 目标
- 完整功能测试
- 性能调优
- 压力测试

#### 任务清单

- [ ] **5.1 功能测试**
  - [ ] DNS 查询测试
  - [ ] HTTP/HTTPS 代理测试
  - [ ] 长连接稳定性测试

- [ ] **5.2 性能测试**
  - [ ] 吞吐量测试
  - [ ] 延迟测试
  - [ ] 内存使用测试
  - [ ] CPU 使用测试

- [ ] **5.3 压力测试**
  - [ ] 1,000 并发连接
  - [ ] 10,000 pps 流量
  - [ ] 24 小时长期运行

- [ ] **5.4 性能调优**
  - [ ] Profile 热点函数
  - [ ] 优化锁竞争
  - [ ] 优化内存分配

**验收标准**：
- ✅ 所有功能测试通过
- ✅ 性能优于旧架构
- ✅ 24 小时无崩溃

---

### 阶段 6：部署和切换（第 6 周）

#### 目标
- 灰度发布
- 监控和回滚准备
- 完全切换

#### 任务清单

- [ ] **6.1 灰度发布**
  - [ ] 5% 流量切换
  - [ ] 监控指标
  - [ ] 逐步增加到 100%

- [ ] **6.2 监控**
  - [ ] 设置告警
  - [ ] 实时仪表盘
  - [ ] 日志聚合

- [ ] **6.3 文档**
  - [ ] 更新操作手册
  - [ ] 编写故障排查指南
  - [ ] 性能调优指南

- [ ] **6.4 清理旧代码**
  - [ ] 移除旧代码（保留备份）
  - [ ] 更新构建脚本
  - [ ] 归档迁移文档

**验收标准**：
- ✅ 新架构稳定运行
- ✅ 性能达标
- ✅ 文档完整

---

## 📊 对比测试

### 性能指标

| 指标 | 旧架构 | 新架构目标 | 测试方法 |
|-----|--------|-----------|---------|
| 吞吐量 | ? | 50,000 pps | iperf3 |
| 延迟（P99） | ? | < 5ms | 自定义测试 |
| 并发连接 | ? | 10,000 | ab / wrk |
| CPU 使用 | ? | < 50% | top / htop |
| 内存使用 | ? | < 500MB | valgrind |

### 功能对比

| 功能 | 旧架构 | 新架构 |
|-----|--------|--------|
| UDP 转发 | ✅ | ✅ |
| TCP 转发 | ❌ | ✅ |
| DNS 缓存 | ❌ | ✅ |
| IPv6 支持 | ⚠️ | ✅ |
| 配置热重载 | ❌ | ✅ |
| 性能监控 | ❌ | ✅ |

---

## 🔄 回滚计划

### 触发条件
- 性能低于旧架构 20%
- 严重 bug 无法快速修复
- 稳定性问题

### 回滚步骤
1. 停止新架构服务
2. 启动旧架构服务
3. 切换流量
4. 验证功能
5. 分析问题

**回滚时间估计**：< 15 分钟

---

## 📝 检查清单

### 开发阶段
- [ ] 所有代码 review 通过
- [ ] 单元测试覆盖率 > 80%
- [ ] 无编译警告
- [ ] 静态分析无问题（cppcheck）
- [ ] 无内存泄漏（valgrind）

### 测试阶段
- [ ] 功能测试全部通过
- [ ] 性能测试达标
- [ ] 压力测试通过
- [ ] 兼容性测试通过

### 部署阶段
- [ ] 部署文档完整
- [ ] 监控配置完成
- [ ] 告警规则设置
- [ ] 回滚预案测试

---

## 🚨 风险和缓解

### 风险 1：性能不达预期
**概率**：中
**影响**：高
**缓解**：
- 提前做性能基准测试
- Profile 关键路径
- 预留调优时间

### 风险 2：兼容性问题
**概率**：低
**影响**：中
**缓解**：
- 充分测试各种客户端
- 保留旧协议兼容性
- 灰度发布

### 风险 3：学习曲线
**概率**：中
**影响**：中
**缓解**：
- 详细的代码文档
- 团队培训
- 结对编程

---

## 📞 联系人

| 角色 | 负责人 | 联系方式 |
|-----|--------|---------|
| 项目负责人 | TBD | - |
| 架构设计 | TBD | - |
| 开发 | TBD | - |
| 测试 | TBD | - |
| 运维 | TBD | - |

---

## 📅 里程碑

| 里程碑 | 日期 | 状态 |
|--------|-----|-----|
| 架构设计完成 | Week 0 | ✅ |
| 基础设施就绪 | Week 1 | 🔄 |
| 网络层完成 | Week 2 | ⏳ |
| 数据包处理完成 | Week 3 | ⏳ |
| 转发层完成 | Week 4 | ⏳ |
| 测试完成 | Week 5 | ⏳ |
| 正式上线 | Week 6 | ⏳ |

---

**最后更新**：2026-01-16
**版本**：1.0
