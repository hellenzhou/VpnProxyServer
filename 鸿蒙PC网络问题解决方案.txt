╔═══════════════════════════════════════════════════════════════╗
║            鸿蒙 PC (HarmonyOS) 网络连接问题解决方案              ║
╚═══════════════════════════════════════════════════════════════╝

📌 当前问题：
   ✅ UDP 连接正常（DNS 可以工作）
   ❌ TCP 连接全部失败（无法访问网站）
   
   诊断结果：1/5 项测试通过 - 部分网络连接受限

═══════════════════════════════════════════════════════════════

🔍 问题原因：

HarmonyOS PC 的安全机制阻止了应用的 TCP 网络连接。
可能的原因：
1. 应用未获得完整的网络访问权限
2. 系统安全策略限制了 TCP 出站连接
3. 沙箱机制限制了应用的网络能力

═══════════════════════════════════════════════════════════════

✅ 已完成的修复：

1. 权限配置已优化（module.json5）：
   ✓ ohos.permission.INTERNET (always)
   ✓ ohos.permission.GET_NETWORK_INFO (always)
   ✓ ohos.permission.SET_NETWORK_INFO (always)
   ✓ ohos.permission.ACCESS_WIFI_STATE (always - 新增)

2. 所有权限的使用场景已改为"always"（包括后台）

═══════════════════════════════════════════════════════════════

🚀 解决步骤（按顺序尝试）：

【步骤1】重新编译和安装应用
───────────────────────────────────────────────────────────

1. 清理旧的构建文件：
   在 VpnProxyServer 目录下运行：
   clean.cmd
   
   或手动删除：
   VpnProxyServer\entry\build\

2. 重新编译：
   在 DevEco Studio 中点击 "Build" → "Rebuild Project"
   
   或命令行：
   F:\Huawei\DevEco Studio\tools\node\node.exe ^
   F:\Huawei\DevEco Studio\tools\hvigor\bin\hvigorw.js ^
   --mode module -p module=entry@default assembleHap

3. 卸载旧版本：
   hdc uninstall com.hellen.vpnserver

4. 安装新版本：
   在 DevEco Studio 中点击 "Run"

5. 启动应用并查看日志，看是否有权限提示


【步骤2】在 HarmonyOS PC 设置中手动授权
───────────────────────────────────────────────────────────

方法A：通过系统设置
   1. 打开"设置"
   2. 进入以下路径之一：
      • 隐私 → 权限管理 → 找到 VPN 应用
      • 安全 → 应用权限 → 找到 VPN 应用
      • 应用 → 应用管理 → 找到 VPN 应用 → 权限
   3. 确保所有网络相关权限都已开启
   4. 特别注意：
      ☑️ 访问互联网
      ☑️ 网络访问
      ☑️ 后台网络访问
      ☑️ WiFi 信息

方法B：开发者选项
   1. 启用开发者模式：
      设置 → 关于 → 连续点击"版本号"7次
   2. 进入开发者选项：
      设置 → 系统 → 开发者选项
   3. 启用以下选项（如果有）：
      ☑️ 允许调试应用完整网络访问
      ☑️ 不限制后台应用网络
      ☑️ 允许所有应用网络调试


【步骤3】使用 hdc 命令检查和授权
───────────────────────────────────────────────────────────

打开命令行（PowerShell 或 CMD），依次运行：

# 1. 检查设备连接
hdc list targets

# 2. 查看应用是否正确安装
hdc shell bm dump -n com.hellen.vpnserver

# 3. 尝试手动授权（某些权限可能需要用户交互）
hdc shell pm grant com.hellen.vpnserver ohos.permission.INTERNET
hdc shell pm grant com.hellen.vpnserver ohos.permission.GET_NETWORK_INFO
hdc shell pm grant com.hellen.vpnserver ohos.permission.SET_NETWORK_INFO
hdc shell pm grant com.hellen.vpnserver ohos.permission.ACCESS_WIFI_STATE

# 4. 查看应用进程和网络状态
hdc shell ps -ef | findstr vpn
hdc shell netstat -an | findstr ESTABLISHED


【步骤4】检查 HarmonyOS PC 网络环境
───────────────────────────────────────────────────────────

1. 确认 PC 本身能上网：
   • 打开浏览器访问 www.baidu.com
   • 确认网络连接正常

2. 检查是否在受限网络：
   • 企业网络可能有额外限制
   • 学校网络可能阻止某些应用
   • 如果是受限环境，联系网络管理员

3. 检查网络类型：
   • WiFi 连接：检查 WiFi 设置
   • 有线连接：检查网络适配器设置


【步骤5】调试模式测试
───────────────────────────────────────────────────────────

1. 在 DevEco Studio 中以调试模式运行：
   • 点击 "Debug" 按钮而不是 "Run"
   • 观察日志输出
   • 查看是否有额外的权限请求或错误信息

2. 查看完整启动日志：
   hdc shell hilog | findstr "VpnServer\|INTERNET\|network"

3. 特别注意日志中的：
   • Permission denied
   • Network unreachable
   • Connection refused
   • 任何权限相关的错误


【步骤6】测试简化版本
───────────────────────────────────────────────────────────

如果上述方法都不行，创建一个极简测试应用：

1. 只包含基本的 TCP 连接测试
2. 不包含 VPN 相关功能
3. 只测试能否连接到 www.baidu.com:80

这样可以确定是否是 HarmonyOS PC 的系统限制。

═══════════════════════════════════════════════════════════════

📊 验证是否成功：

重新运行应用后，查看日志应该显示：

╔═══════════════════════════════════════════════════════╗
║   成功: 5/5 项测试通过                                ║
║   状态: ✅ 网络连接正常，可以正常使用                   ║
╚═══════════════════════════════════════════════════════╝

✅ UDP DNS测试成功 - 收到响应 83 字节
✅ 成功连接到百度 (www.baidu.com)
✅ 成功连接到淘宝 (www.taobao.com)
✅ 成功连接到腾讯 (www.qq.com)
✅ 成功连接到阿里云公网服务器

═══════════════════════════════════════════════════════════════

🔧 HarmonyOS PC 特定问题：

问题1：沙箱限制
   HarmonyOS 的沙箱可能比其他系统更严格。
   解决：需要在系统设置中明确授权应用。

问题2：后台网络限制
   应用在后台时可能被限制网络访问。
   解决：设置中允许应用后台网络访问。

问题3：开发版本限制
   如果使用的是 HarmonyOS PC 的早期或测试版本。
   解决：更新到最新稳定版本。

问题4：企业策略
   如果是企业版 HarmonyOS PC。
   解决：联系 IT 管理员了解网络策略。

═══════════════════════════════════════════════════════════════

💡 常见疑问：

Q: 为什么 UDP 能通但 TCP 不能？
A: 某些系统对 UDP 和 TCP 有不同的安全策略。UDP 通常用于
   DNS 等基础服务，限制较少；TCP 用于数据传输，限制更严。

Q: 权限都授予了还是不行怎么办？
A: 可能是系统级别的限制，需要：
   1. 联系华为技术支持
   2. 在华为开发者论坛寻求帮助
   3. 考虑使用系统管理员权限运行

Q: 是否需要特殊的开发者证书？
A: 正式发布的应用可能需要华为的开发者证书和审核。
   开发测试阶段应该可以直接安装运行。

═══════════════════════════════════════════════════════════════

📞 需要进一步帮助？

如果按照上述所有步骤操作后仍然无法解决，请提供：

1. 完整的应用启动日志（从启动到网络测试结束）
2. hdc shell hilog 的完整输出
3. HarmonyOS PC 版本信息：
   设置 → 关于 → 系统版本
4. 是否在企业或学校网络环境
5. 是否有其他应用能正常使用网络

可以在以下渠道寻求帮助：
• 华为开发者论坛：https://developer.huawei.com/consumer/cn/forum/
• HarmonyOS 技术支持
• DevEco Studio 官方文档

═══════════════════════════════════════════════════════════════

📝 下一步操作清单：

☐ 1. 重新编译应用（已更新权限配置）
☐ 2. 卸载旧版本，安装新版本
☐ 3. 在系统设置中检查并授予所有网络权限
☐ 4. 启用开发者选项中的网络相关选项
☐ 5. 使用 hdc 命令手动授权
☐ 6. 重新运行应用，查看网络测试结果
☐ 7. 如果还是失败，收集完整日志并寻求技术支持

═══════════════════════════════════════════════════════════════

最后更新：2026-01-14
版本：v2.0 - 针对 HarmonyOS PC 优化
