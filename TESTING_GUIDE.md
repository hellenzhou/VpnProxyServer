# VPN代理服务器测试指南

## 🔄 重构完成情况

✅ 数据包构建器 - 实现IP包的封装和解封装  
✅ NAT映射表 - 管理连接状态  
✅ PacketForwarder重构 - 正确处理payload  
✅ 响应包重新封装 - 构建完整IP包  

## 📋 测试步骤

### 1. 编译项目
```bash
# 清理之前的构建
rm -rf .cxx build

# 重新构建
hvigor assembleHap
```

### 2. 启动服务器
- 在HarmonyOS设备上安装并运行VpnProxyServer应用
- 点击"启动服务器"按钮
- 确认看到日志: `✅ Server fully initialized and ready for connections`

### 3. 启动客户端
- 在另一台设备上运行VPN客户端
- 连接到服务器IP:8888
- 确认VPN连接建立

### 4. 测试DNS解析

**预期日志**:
```
📦 [转发-新] 开始: 192.168.100.2:xxxxx -> 114.114.114.114:53 (UDP)
✅ [转发-新] 提取payload: XX字节
✅ [UDP-新] payload已发送: XX字节
📬 [UDP响应-新] 收到payload: XX字节
📦 [UDP响应-新] 已构建完整IP包: XX字节
✅ [UDP响应-新] 完整IP包已发送给客户端: XX字节
```

**验证方法**:
- 客户端执行: `nslookup www.baidu.com`
- 应该能正常解析

### 5. 测试HTTP请求

**预期日志**:
```
📦 [转发-新] 开始: 192.168.100.2:xxxxx -> X.X.X.X:80 (TCP)
🔌 [TCP-新] 正在连接 X.X.X.X:80...
✅ [TCP-新] 连接成功
✅ [TCP-新] payload已发送: XX字节
📬 [TCP响应-新] 收到payload: XX字节
✅ [TCP响应-新] 完整IP包已发送给客户端: XX字节
```

**验证方法**:
- 客户端执行: `curl http://www.baidu.com`
- 应该能看到HTML响应

### 6. 测试HTTPS请求

**预期日志**:
```
📦 [转发-新] 开始: 192.168.100.2:xxxxx -> X.X.X.X:443 (TCP)
🔌 [TCP-新] 正在连接 X.X.X.X:443...
✅ [TCP-新] 连接成功
```

**验证方法**:
- 客户端浏览器访问: `https://www.baidu.com`
- 应该能正常加载页面

### 7. 查看NAT映射表

**预期日志**:
```
✅ Created NAT mapping: 192.168.100.2:xxxxx->X.X.X.X:80/TCP
   Client Physical: 127.0.0.1:55751
   Client Virtual: 192.168.100.2:xxxxx
   Server: X.X.X.X:80
   Forward Socket: XX, Protocol: TCP
   Total mappings: X
```

**验证方法**:
- 确认每个新连接都创建了NAT映射
- 同一连接的后续数据包能复用映射: `♻️ [转发-新] 复用现有连接`

## 🔍 问题诊断

### 问题1: DNS查询失败
**症状**: 无法解析域名  
**检查**:
- [ ] payload是否正确提取（应该不包含IP头）
- [ ] 是否看到 `✅ [UDP-新] payload已发送`
- [ ] 是否收到响应 `📬 [UDP响应-新] 收到payload`
- [ ] 响应包是否正确构建和发送

**调试日志关键字**: `[UDP-新]`, `[UDP响应-新]`, `ExtractPayload`

### 问题2: TCP连接超时
**症状**: `❌ [TCP-新] 连接失败`  
**检查**:
- [ ] 目标服务器是否可达（ping测试）
- [ ] 是否有防火墙阻止
- [ ] socket是否设置为阻塞模式
- [ ] 连接超时时间是否合理

**调试日志关键字**: `[TCP-新]`, `正在连接`, `连接成功`

### 问题3: 响应包无法发回客户端
**症状**: 服务器收到响应但客户端没收到  
**检查**:
- [ ] NAT映射是否存在: `✅ Created NAT mapping`
- [ ] 能否通过socket找到映射: `FindMappingBySocket`
- [ ] IP包是否正确构建: `📦 已构建完整IP包`
- [ ] 是否发送给正确的客户端地址

**调试日志关键字**: `BuildResponsePacket`, `完整IP包已发送`

### 问题4: 没有payload
**症状**: `ℹ️ [转发-新] payload为空`  
**说明**: 这通常是正常的
- TCP SYN/ACK/FIN等控制包没有payload
- 这些包用于建立/关闭连接，不需要转发

## 📊 性能监控

### NAT表大小
- 正常: < 1000个映射
- 警告: > 5000个映射（可能有泄漏）
- 错误: > 10000个映射（需要清理）

### 连接复用率
- 检查日志中 `♻️ 复用现有连接` 的比例
- HTTP/1.1 应该有较高的复用率

### 响应延迟
- DNS: < 100ms
- HTTP: < 500ms
- HTTPS: < 1000ms (包含TLS握手)

## 🐛 已知问题

1. **TCP序列号简化处理** - 可能导致某些TCP连接不稳定
2. **不支持分片** - 大于MTU的包可能失败
3. **ICMPv6被忽略** - IPv6邻居发现等功能不可用
4. **每连接一线程** - 高并发时性能受限

## ✅ 成功标准

- [ ] DNS查询成功返回
- [ ] HTTP请求能正常返回HTML
- [ ] HTTPS连接能建立并加载页面
- [ ] NAT映射正确创建和清理
- [ ] 连接能正确复用
- [ ] 无内存泄漏（长时间运行后NAT表不爆炸）
- [ ] 多客户端能同时使用

## 📝 测试报告模板

```
测试日期: YYYY-MM-DD
测试环境: HarmonyOS X.X
服务器版本: 重构版 v2.0

测试项目 | 状态 | 备注
--------|------|------
DNS解析  | ✅/❌ | 
HTTP请求 | ✅/❌ | 
HTTPS连接| ✅/❌ | 
连接复用 | ✅/❌ | 
NAT管理  | ✅/❌ | 
多客户端 | ✅/❌ | 

问题列表:
1. [描述问题]
2. [描述问题]

改进建议:
1. [建议]
2. [建议]
```
