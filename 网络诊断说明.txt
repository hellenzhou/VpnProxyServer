╔═══════════════════════════════════════════════════════════════╗
║                    VPN 代理服务器网络诊断说明                     ║
╚═══════════════════════════════════════════════════════════════╝

📌 重要更新：
   代理服务器启动时会自动运行网络诊断测试！

═══════════════════════════════════════════════════════════════

🔍 诊断内容：

服务器启动时会自动测试以下连接：

1. ✓ UDP DNS 连接测试
   - 测试到 10.20.2.74:53 的 DNS 查询

2. ✓ TCP 连接测试：百度
   - 测试到 110.242.68.66:80 (www.baidu.com)

3. ✓ TCP 连接测试：淘宝  
   - 测试到 140.205.94.189:80 (www.taobao.com)

4. ✓ TCP 连接测试：腾讯
   - 测试到 183.3.226.35:80 (www.qq.com)

5. ✓ TCP 连接测试：阿里云
   - 测试到 47.95.164.112:80 (阿里云公网服务器)

═══════════════════════════════════════════════════════════════

📊 如何查看测试结果：

方法1：DevEco Studio 日志窗口
   - 打开 DevEco Studio
   - 在底部找到 "Log" 或 "日志" 标签
   - 启动应用后，搜索 "网络连接诊断测试"
   - 查看测试结果摘要

方法2：hdc shell logcat（命令行）
   1. 打开命令提示符(CMD)或PowerShell
   2. 运行：hdc shell logcat | findstr "网络"
   3. 启动应用，查看实时日志

═══════════════════════════════════════════════════════════════

✅ 测试结果解读：

【全部成功】5/5 项测试通过
   ✅ 网络连接正常，VPN可以正常工作
   → 如果VPN还是不能上网，问题可能在VPN客户端

【部分成功】例如 1/5 或 2/5 项测试通过  
   ⚠️  部分网络连接受限
   → UDP 能通但 TCP 不能通 = 防火墙阻止TCP
   → 说明：您的情况很可能是这个（UDP DNS成功，TCP全失败）

【全部失败】0/5 项测试通过
   ❌ 网络完全不可用
   → 鸿蒙PC根本没有网络连接
   → 请检查：
      • PC是否连接到WiFi或有线网络
      • 浏览器能否正常访问网站
      • 是否在隔离的网络环境中

═══════════════════════════════════════════════════════════════

🛠️ 针对 "UDP成功但TCP失败" 的解决方案：

问题根源：
   Windows防火墙或第三方安全软件阻止了应用的TCP出站连接

解决步骤：

方案A：Windows Defender 防火墙（推荐）
   1. 按 Win + R，输入：control firewall.cpl
   2. 点击左侧"允许应用通过 Windows Defender 防火墙"
   3. 点击"更改设置"按钮
   4. 点击"允许其他应用"
   5. 找到您的应用（VPN代理服务器）
   6. 勾选"专用"和"公用"网络
   7. 确定保存

方案B：关闭防火墙临时测试（仅用于诊断）
   1. 按 Win + R，输入：control firewall.cpl
   2. 点击左侧"启用或关闭 Windows Defender 防火墙"
   3. 两个网络类型都选择"关闭"
   4. 测试VPN是否能工作
   5. 如果能工作，说明确实是防火墙问题
   6. 记得测试后重新启用防火墙！

方案C：第三方安全软件
   如果安装了：360安全卫士、腾讯电脑管家、瑞星等
   → 进入该软件的防火墙设置
   → 将VPN代理服务器应用添加到信任列表

方案D：企业网络环境
   如果在公司或学校：
   → 可能有网络策略限制
   → 联系IT管理员咨询是否允许VPN应用

═══════════════════════════════════════════════════════════════

🚀 构建和运行步骤：

1. 构建项目：
   在 VpnProxyServer 目录下运行：
   F:\Huawei\DevEco Studio\tools\node\node.exe ^
   F:\Huawei\DevEco Studio\tools\hvigor\bin\hvigorw.js ^
   --mode module -p module=entry@default assembleHap

2. 安装到设备：
   • DevEco Studio：点击"运行"按钮
   • 或命令行：hdc install entry-default-signed.hap

3. 启动应用：
   打开应用后，会自动运行网络诊断测试

4. 查看日志：
   在 DevEco Studio 的 Log 窗口查看诊断结果

═══════════════════════════════════════════════════════════════

📝 典型日志示例：

✅ 正常情况（全部通过）：
   ╔═══════════════════════════════════════════════════════╗
   ║   📊 网络诊断测试结果                                  ║
   ╠═══════════════════════════════════════════════════════╣
   ║   成功: 5/5 项测试通过                                ║
   ║   状态: ✅ 网络连接正常，可以正常使用                   ║
   ╚═══════════════════════════════════════════════════════╝

❌ 您当前的情况（TCP被阻止）：
   ╔═══════════════════════════════════════════════════════╗
   ║   📊 网络诊断测试结果                                  ║
   ╠═══════════════════════════════════════════════════════╣
   ║   成功: 1/5 项测试通过                                ║
   ║   状态: ⚠️  部分网络连接受限                           ║
   ║   建议: 检查防火墙或网络策略设置                       ║
   ╚═══════════════════════════════════════════════════════╝
   
   详细信息：
   ✅ UDP DNS测试成功
   ❌ 连接百度超时 (5秒)
   ❌ 连接淘宝超时 (5秒)
   ❌ 连接腾讯超时 (5秒)
   ❌ 连接阿里云超时 (5秒)

═══════════════════════════════════════════════════════════════

💡 常见问题：

Q: 为什么UDP成功但TCP全部失败？
A: 这是典型的防火墙阻止TCP出站连接的表现。DNS使用UDP协议，
   所以UDP测试通过；但网页访问等使用TCP协议，被防火墙阻止了。

Q: 我确定电脑能上网，为什么测试还是失败？
A: 浏览器可能被加入了防火墙白名单，但您的VPN应用没有。
   需要手动将VPN应用添加到防火墙允许列表。

Q: 临时关闭防火墙测试后能工作，怎么办？
A: 说明确实是防火墙问题。重新启用防火墙后，按照"方案A"
   将应用添加到允许列表即可。

Q: 在企业网络环境怎么办？
A: 企业可能有更严格的网络策略，建议联系IT部门咨询。
   可能需要申请网络权限或使用公司批准的VPN方案。

═══════════════════════════════════════════════════════════════

📞 需要帮助？

如果按照上述步骤操作后仍然无法解决问题，请提供：
1. 完整的诊断测试日志（从启动到测试结束）
2. 操作系统版本（Win10/Win11）
3. 是否安装了第三方安全软件
4. 网络环境（家庭/企业/学校）

═══════════════════════════════════════════════════════════════

最后更新：2026-01-14
版本：v1.2 - 增强网络诊断功能
