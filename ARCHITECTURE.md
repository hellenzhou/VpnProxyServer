# VpnProxyServer æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ•°æ®æµ](#æ•°æ®æµ)
5. [è°ƒç”¨æ—¶åº](#è°ƒç”¨æ—¶åº)
6. [çº¿ç¨‹æ¨¡å‹](#çº¿ç¨‹æ¨¡å‹)
7. [å…³é”®æ•°æ®ç»“æ„](#å…³é”®æ•°æ®ç»“æ„)
8. [åè®®æ”¯æŒ](#åè®®æ”¯æŒ)

---

## é¡¹ç›®æ¦‚è¿°

VpnProxyServer æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ HarmonyOS ä¸Šçš„ VPN ä»£ç†æœåŠ¡å™¨ï¼Œè´Ÿè´£æ¥æ”¶æ¥è‡ª VPN å®¢æˆ·ç«¯çš„ç½‘ç»œæ•°æ®åŒ…ï¼Œå¹¶å°†å…¶è½¬å‘åˆ°çœŸå®çš„äº’è”ç½‘æœåŠ¡å™¨ã€‚å®ƒå®ç°äº†å®Œæ•´çš„ NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰åŠŸèƒ½ï¼Œæ”¯æŒ TCPã€UDPã€ICMPã€ICMPv6 åè®®ã€‚

### ä¸»è¦åŠŸèƒ½
- âœ… æ¥æ”¶ VPN å®¢æˆ·ç«¯å‘é€çš„ IP æ•°æ®åŒ…
- âœ… è§£æ IPv4/IPv6 æ•°æ®åŒ…
- âœ… æ”¯æŒ TCP/UDP/ICMP/ICMPv6 åè®®è½¬å‘
- âœ… NAT æ˜ å°„ç®¡ç†ï¼ˆè™šæ‹Ÿåœ°å€ â†” çœŸå®åœ°å€ï¼‰
- âœ… å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—å¤„ç†
- âœ… å¤šçº¿ç¨‹å¹¶å‘å¤„ç†
- âœ… UDP é‡ä¼ æœºåˆ¶
- âœ… ç½‘ç»œè¯Šæ–­åŠŸèƒ½

---

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HarmonyOS Application                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ETS Layer (UI/Logic)                     â”‚  â”‚
â”‚  â”‚  - Index.ets (UIç•Œé¢)                                  â”‚  â”‚
â”‚  â”‚  - startServer(port) / stopServer()                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ NAPI Bridge
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Native C++ Layer                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  vpn_server.cpp (ä¸»å…¥å£)                              â”‚  â”‚
â”‚  â”‚  - StartServer() / StopServer()                       â”‚  â”‚
â”‚  â”‚  - WorkerLoop() (ä¸»æ¥æ”¶å¾ªç¯)                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ProtocolHandler (åè®®è§£æ)                          â”‚  â”‚
â”‚  â”‚  - ParseIPPacket()                                    â”‚  â”‚
â”‚  â”‚  - ValidatePacket()                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  TaskQueueManager (ä»»åŠ¡é˜Ÿåˆ—)                         â”‚  â”‚
â”‚  â”‚  - submitForwardTask()                               â”‚  â”‚
â”‚  â”‚  - submitResponseTask()                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  WorkerThreadPool (å·¥ä½œçº¿ç¨‹æ± )                       â”‚  â”‚
â”‚  â”‚  - forwardWorkerThread() (è½¬å‘çº¿ç¨‹)                  â”‚  â”‚
â”‚  â”‚  - responseWorkerThread() (å“åº”çº¿ç¨‹)                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PacketForwarder (æ•°æ®åŒ…è½¬å‘)                        â”‚  â”‚
â”‚  â”‚  - ForwardPacket()                                    â”‚  â”‚
â”‚  â”‚  - StartTCPThread() / StartUDPThread()                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  NATTable (NATæ˜ å°„è¡¨)                                â”‚  â”‚
â”‚  â”‚  - CreateMapping()                                    â”‚  â”‚
â”‚  â”‚  - FindMapping()                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Socket I/O
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Physical Network (Internet)                    â”‚
â”‚  - TCP/UDP/ICMP Connections                                 â”‚
â”‚  - Real Servers (8.8.8.8, www.baidu.com, etc.)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. vpn_server.cpp (ä¸»æœåŠ¡å™¨)

**èŒè´£**ï¼š
- æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆå¯åŠ¨/åœæ­¢ï¼‰
- UDP Socket ç›‘å¬ï¼ˆæ¥æ”¶å®¢æˆ·ç«¯æ•°æ®åŒ…ï¼‰
- ä¸»å·¥ä½œå¾ªç¯ï¼ˆWorkerLoopï¼‰
- NAPI æ¥å£å¯¼å‡º

**å…³é”®å‡½æ•°**ï¼š
```cpp
// NAPI å¯¼å‡ºå‡½æ•°
napi_value StartServer(napi_env env, napi_callback_info info)
napi_value StopServer(napi_env env, napi_callback_info info)
napi_value GetStats(napi_env env, napi_callback_info info)

// å†…éƒ¨å‡½æ•°
void WorkerLoop()  // ä¸»æ¥æ”¶å¾ªç¯
void UpdateClientInfo(...)  // æ›´æ–°å®¢æˆ·ç«¯ä¿¡æ¯
```

**å…¨å±€å˜é‡**ï¼š
- `g_running`: æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€ï¼ˆatomic<bool>ï¼‰
- `g_sockFd`: UDP ç›‘å¬ socketï¼ˆatomic<int>ï¼‰
- `g_worker`: ä¸»å·¥ä½œçº¿ç¨‹ï¼ˆstd::threadï¼‰
- `g_packetsReceived/Sent`: ç»Ÿè®¡ä¿¡æ¯ï¼ˆatomic<uint64_t>ï¼‰

---

### 2. ProtocolHandler (åè®®å¤„ç†å™¨)

**æ–‡ä»¶**: `protocol_handler.cpp/h`

**èŒè´£**ï¼š
- è§£æ IPv4/IPv6 æ•°æ®åŒ…
- æå–æº/ç›®æ ‡ IPã€ç«¯å£ã€åè®®ç±»å‹
- éªŒè¯æ•°æ®åŒ…æœ‰æ•ˆæ€§

**å…³é”®å‡½æ•°**ï¼š
```cpp
PacketInfo ParseIPPacket(const uint8_t* data, int dataSize)
bool ValidatePacket(const PacketInfo& info)
std::string GetProtocolName(uint8_t protocol)
```

**æ”¯æŒåè®®**ï¼š
- IPv4: TCP(6), UDP(17), ICMP(1)
- IPv6: TCP(6), UDP(17), ICMPv6(58)

**æ•°æ®ç»“æ„**ï¼š
```cpp
struct PacketInfo {
    bool isValid;
    int addressFamily;      // AF_INET or AF_INET6
    uint8_t protocol;       // PROTOCOL_TCP/UDP/ICMP/ICMPV6
    std::string sourceIP;
    std::string targetIP;
    int sourcePort;
    int targetPort;
    uint8_t icmpv6Type;     // ICMP/ICMPv6 ç±»å‹
    uint8_t icmpv6Code;     // ICMP/ICMPv6 ä»£ç 
};
```

---

### 3. TaskQueueManager (ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å™¨)

**æ–‡ä»¶**: `task_queue.cpp/h`

**èŒè´£**ï¼š
- ç®¡ç†è½¬å‘ä»»åŠ¡é˜Ÿåˆ—ï¼ˆForwardTaskï¼‰
- ç®¡ç†å“åº”ä»»åŠ¡é˜Ÿåˆ—ï¼ˆResponseTaskï¼‰
- çº¿ç¨‹å®‰å…¨çš„ä»»åŠ¡æäº¤å’Œè·å–

**å…³é”®å‡½æ•°**ï¼š
```cpp
void submitForwardTask(const ForwardTask& task)
void submitResponseTask(const uint8_t* data, int size, ...)
bool getForwardTask(ForwardTask& task, int timeoutMs)
bool getResponseTask(ResponseTask& task, int timeoutMs)
void clear()  // æ¸…ç©ºé˜Ÿåˆ—
```

**æ•°æ®ç»“æ„**ï¼š
```cpp
struct ForwardTask {
    PacketInfo packetInfo;
    uint8_t* data;
    int dataSize;
    sockaddr_in originalPeer;  // å®¢æˆ·ç«¯åœ°å€
    int tunnelFd;
};

struct ResponseTask {
    uint8_t* data;
    int dataSize;
    sockaddr_in targetPeer;    // ç›®æ ‡å®¢æˆ·ç«¯åœ°å€
    int tunnelFd;
    uint8_t protocol;
};
```

---

### 4. WorkerThreadPool (å·¥ä½œçº¿ç¨‹æ± )

**æ–‡ä»¶**: `worker_thread_pool.cpp/h`

**èŒè´£**ï¼š
- ç®¡ç†è½¬å‘å·¥ä½œçº¿ç¨‹ï¼ˆå¤„ç†å®¢æˆ·ç«¯â†’æœåŠ¡å™¨ï¼‰
- ç®¡ç†å“åº”å·¥ä½œçº¿ç¨‹ï¼ˆå¤„ç†æœåŠ¡å™¨â†’å®¢æˆ·ç«¯ï¼‰
- çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸç®¡ç†

**å…³é”®å‡½æ•°**ï¼š
```cpp
void start(int numForwardWorkers, int numResponseWorkers)
void stop()  // åœæ­¢æ‰€æœ‰çº¿ç¨‹
void forwardWorkerThread()  // è½¬å‘çº¿ç¨‹ä¸»å¾ªç¯
void responseWorkerThread()  // å“åº”çº¿ç¨‹ä¸»å¾ªç¯
```

**çº¿ç¨‹æ¨¡å‹**ï¼š
- **è½¬å‘çº¿ç¨‹**ï¼šä» `forwardQueue` è·å–ä»»åŠ¡ â†’ è°ƒç”¨ `PacketForwarder::ForwardPacket()` â†’ è½¬å‘åˆ°çœŸå®æœåŠ¡å™¨
- **å“åº”çº¿ç¨‹**ï¼šä» `responseQueue` è·å–ä»»åŠ¡ â†’ å‘é€å“åº”æ•°æ®åŒ…åˆ° VPN å®¢æˆ·ç«¯

---

### 5. PacketForwarder (æ•°æ®åŒ…è½¬å‘å™¨)

**æ–‡ä»¶**: `packet_forwarder.cpp/h`

**èŒè´£**ï¼š
- è½¬å‘æ•°æ®åŒ…åˆ°çœŸå®æœåŠ¡å™¨
- ç®¡ç† TCP/UDP Socket è¿æ¥
- å¯åŠ¨å“åº”æ¥æ”¶çº¿ç¨‹
- TCP çŠ¶æ€æœºç®¡ç†

**å…³é”®å‡½æ•°**ï¼š
```cpp
int ForwardPacket(const uint8_t* data, int dataSize, 
                  const PacketInfo& packetInfo,
                  const sockaddr_in& originalPeer, int tunnelFd)

void StartTCPThread(int sockFd, const sockaddr_in& originalPeer)
void StartUDPThread(int sockFd, const sockaddr_in& originalPeer)

int GetSocket(const PacketInfo& packetInfo, ...)  // è·å–æˆ–åˆ›å»ºsocket
```

**TCP å¤„ç†æµç¨‹**ï¼š
1. æ”¶åˆ° SYN â†’ åˆ›å»º TCP socket â†’ è¿æ¥åˆ°ç›®æ ‡æœåŠ¡å™¨
2. å‘é€ SYN-ACK ç»™å®¢æˆ·ç«¯
3. æ”¶åˆ° ACK â†’ è¿æ¥å»ºç«‹å®Œæˆ
4. æ”¶åˆ°æ•°æ® â†’ è½¬å‘åˆ°æœåŠ¡å™¨
5. æ”¶åˆ° FIN â†’ å…³é—­è¿æ¥

**UDP å¤„ç†æµç¨‹**ï¼š
1. æ”¶åˆ° UDP åŒ… â†’ è·å–æˆ–åˆ›å»º UDP socket
2. å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨
3. å¯åŠ¨ UDP å“åº”çº¿ç¨‹ç›‘å¬å“åº”

---

### 6. NATTable (NAT æ˜ å°„è¡¨)

**æ–‡ä»¶**: `nat_table.cpp/h`

**èŒè´£**ï¼š
- ç®¡ç†è™šæ‹Ÿåœ°å€åˆ°çœŸå®åœ°å€çš„æ˜ å°„
- å­˜å‚¨ TCP è¿æ¥çŠ¶æ€
- Socket åˆ° NAT Key çš„æ˜ å°„

**å…³é”®å‡½æ•°**ï¼š
```cpp
void CreateMapping(const std::string& key, ...)
bool FindMapping(const std::string& key, NATConnection& conn)
void RemoveMapping(const std::string& key)
std::vector<int> GetAllActiveSockets()  // è·å–æ‰€æœ‰æ´»è·ƒsocket
```

**æ•°æ®ç»“æ„**ï¼š
```cpp
struct NATConnection {
    sockaddr_in clientAddr;      // VPNå®¢æˆ·ç«¯åœ°å€
    std::string serverIP;        // ç›®æ ‡æœåŠ¡å™¨IP
    int serverPort;              // ç›®æ ‡æœåŠ¡å™¨ç«¯å£
    int forwardSocket;            // è½¬å‘socket fd
    uint8_t protocol;             // TCP/UDP
    int addressFamily;            // AF_INET/AF_INET6
    
    // TCPçŠ¶æ€
    enum class TcpState {
        NONE, SYN_RECEIVED, ESTABLISHED, FIN_WAIT, CLOSED
    } tcpState;
    uint32_t clientIsn;           // å®¢æˆ·ç«¯åˆå§‹åºåˆ—å·
    uint32_t serverIsn;           // æœåŠ¡å™¨åˆå§‹åºåˆ—å·
    uint32_t nextClientSeq;       // æœŸæœ›çš„ä¸‹ä¸€ä¸ªå®¢æˆ·ç«¯åºåˆ—å·
    uint32_t nextServerSeq;       // æœŸæœ›çš„ä¸‹ä¸€ä¸ªæœåŠ¡å™¨åºåˆ—å·
};
```

**NAT Key ç”Ÿæˆè§„åˆ™**ï¼š
```
key = "clientIP:clientPort:serverIP:serverPort:protocol:addressFamily"
```

---

### 7. PacketBuilder (æ•°æ®åŒ…æ„å»ºå™¨)

**æ–‡ä»¶**: `packet_builder.cpp/h`

**èŒè´£**ï¼š
- æå– IP æ•°æ®åŒ… payload
- æ„å»ºå“åº”æ•°æ®åŒ…ï¼ˆTCP/UDP/ICMPï¼‰
- è®¡ç®—æ ¡éªŒå’Œ

**å…³é”®å‡½æ•°**ï¼š
```cpp
bool ExtractPayload(const uint8_t* data, int dataSize, 
                    const PacketInfo& info, 
                    const uint8_t** payload, int* payloadSize)

int BuildResponsePacket(uint8_t* buffer, int bufferSize,
                        const uint8_t* payload, int payloadSize,
                        const PacketInfo& originalRequest,
                        const TCPConnectionState& tcpState)

int BuildTcpResponsePacket(...)  // æ„å»ºTCPå“åº”åŒ…
```

---

### 8. UdpRetransmitManager (UDP é‡ä¼ ç®¡ç†å™¨)

**æ–‡ä»¶**: `udp_retransmit.cpp/h`

**èŒè´£**ï¼š
- è®°å½•å·²å‘é€çš„ UDP åŒ…
- æ£€æµ‹ UDP åŒ…ä¸¢å¤±
- å®ç° UDP é‡ä¼ æœºåˆ¶

**å…³é”®å‡½æ•°**ï¼š
```cpp
void recordSentPacket(...)
void checkAndRetransmit(...)
void clear()
```

---

## æ•°æ®æµ

### å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼ˆè¯·æ±‚æµç¨‹ï¼‰

```
1. VPNå®¢æˆ·ç«¯ (TUNè®¾å¤‡)
   â”‚
   â”‚ å‘é€IPæ•°æ®åŒ… (TCP/UDP/ICMP)
   â–¼
2. VpnProxyServer (UDP Socket :8888)
   â”‚
   â”‚ WorkerLoop() recvfrom()
   â–¼
3. ProtocolHandler::ParseIPPacket()
   â”‚
   â”‚ è§£æIPå¤´ã€æå–æº/ç›®æ ‡IPã€ç«¯å£ã€åè®®
   â–¼
4. TaskQueueManager::submitForwardTask()
   â”‚
   â”‚ æäº¤åˆ°è½¬å‘ä»»åŠ¡é˜Ÿåˆ—
   â–¼
5. WorkerThreadPool::forwardWorkerThread()
   â”‚
   â”‚ ä»é˜Ÿåˆ—è·å–ä»»åŠ¡
   â–¼
6. PacketForwarder::ForwardPacket()
   â”‚
   â”‚ â”œâ”€ TCP: åˆ›å»ºTCP socket â†’ connect() â†’ send()
   â”‚ â”œâ”€ UDP: åˆ›å»ºUDP socket â†’ sendto()
   â”‚ â””â”€ ICMP: è®°å½•æ—¥å¿—ï¼ˆæœªå®ç°è½¬å‘ï¼‰
   â–¼
7. çœŸå®æœåŠ¡å™¨ (Internet)
   â”‚
   â”‚ å¤„ç†è¯·æ±‚
   â–¼
8. å“åº”æ•°æ®åŒ…è¿”å›
```

### æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼ˆå“åº”æµç¨‹ï¼‰

```
1. çœŸå®æœåŠ¡å™¨å“åº”
   â”‚
   â”‚ TCP/UDPå“åº”æ•°æ®
   â–¼
2. PacketForwarder::StartTCPThread() / StartUDPThread()
   â”‚
   â”‚ recv() / recvfrom() æ¥æ”¶å“åº”
   â–¼
3. PacketBuilder::BuildResponsePacket()
   â”‚
   â”‚ æ„å»ºIPå“åº”åŒ…ï¼ˆä¿®æ”¹æº/ç›®æ ‡IPã€ç«¯å£ï¼‰
   â–¼
4. TaskQueueManager::submitResponseTask()
   â”‚
   â”‚ æäº¤åˆ°å“åº”ä»»åŠ¡é˜Ÿåˆ—
   â–¼
5. WorkerThreadPool::responseWorkerThread()
   â”‚
   â”‚ ä»é˜Ÿåˆ—è·å–ä»»åŠ¡
   â–¼
6. sendto() å‘é€åˆ°VPNå®¢æˆ·ç«¯
   â”‚
   â”‚ UDP Socket :8888 â†’ VPNå®¢æˆ·ç«¯
   â–¼
7. VPNå®¢æˆ·ç«¯æ¥æ”¶å“åº”
   â”‚
   â”‚ å†™å…¥TUNè®¾å¤‡
   â–¼
8. åº”ç”¨ç¨‹åºæ”¶åˆ°å“åº”
```

---

## è°ƒç”¨æ—¶åº

### æœåŠ¡å™¨å¯åŠ¨æ—¶åº

```
ETS Layer                    Native C++ Layer
    â”‚                              â”‚
    â”‚ startServer(8888)            â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                              â”‚ StartServer()
    â”‚                              â”‚ â”œâ”€ æ£€æŸ¥ç«¯å£æœ‰æ•ˆæ€§
    â”‚                              â”‚ â”œâ”€ åœæ­¢æ—§æœåŠ¡å™¨å®ä¾‹
    â”‚                              â”‚ â”œâ”€ socket(AF_INET, SOCK_DGRAM)
    â”‚                              â”‚ â”œâ”€ bind(0.0.0.0:8888)
    â”‚                              â”‚ â”œâ”€ WorkerThreadPool::start()
    â”‚                              â”‚ â”‚   â”œâ”€ åˆ›å»ºè½¬å‘çº¿ç¨‹æ± 
    â”‚                              â”‚ â”‚   â””â”€ åˆ›å»ºå“åº”çº¿ç¨‹æ± 
    â”‚                              â”‚ â”œâ”€ g_running = true
    â”‚                              â”‚ â””â”€ g_worker = std::thread(WorkerLoop)
    â”‚                              â”‚     â”‚
    â”‚                              â”‚     â””â”€> WorkerLoop() å¼€å§‹è¿è¡Œ
    â”‚                              â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ return 0
    â”‚                              â”‚
```

### æ•°æ®åŒ…å¤„ç†æ—¶åº

```
WorkerLoop()                  ProtocolHandler          TaskQueue
    â”‚                              â”‚                      â”‚
    â”‚ recvfrom() æ¥æ”¶æ•°æ®åŒ…         â”‚                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
    â”‚                              â”‚ ParseIPPacket()      â”‚
    â”‚                              â”‚ â”œâ”€ è§£æIPv4/IPv6     â”‚
    â”‚                              â”‚ â”œâ”€ æå–IP/ç«¯å£/åè®®  â”‚
    â”‚                              â”‚ â””â”€ è¿”å›PacketInfo    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
    â”‚                              â”‚                      â”‚
    â”‚ submitForwardTask()           â”‚                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                              â”‚                      â”‚ ä»»åŠ¡å…¥é˜Ÿ
    â”‚                              â”‚                      â”‚
    â”‚                              â”‚                      â”‚
WorkerThreadPool              PacketForwarder          NATTable
    â”‚                              â”‚                      â”‚
    â”‚ forwardWorkerThread()         â”‚                      â”‚
    â”‚ â”œâ”€ getForwardTask()          â”‚                      â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                              â”‚                      â”‚
    â”‚ ForwardPacket()               â”‚                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
    â”‚                              â”‚ GenerateKey()         â”‚
    â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                              â”‚ FindMapping()         â”‚
    â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                              â”‚                      â”‚
    â”‚                              â”‚ GetSocket()           â”‚
    â”‚                              â”‚ â”œâ”€ åˆ›å»ºsocket        â”‚
    â”‚                              â”‚ â”œâ”€ connect()/sendto()â”‚
    â”‚                              â”‚ â””â”€ CreateMapping()   â”‚
    â”‚                              â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                              â”‚                      â”‚
    â”‚                              â”‚ StartTCPThread()      â”‚
    â”‚                              â”‚ æˆ– StartUDPThread()  â”‚
    â”‚                              â”‚                      â”‚
```

### TCP è¿æ¥å»ºç«‹æ—¶åº

```
å®¢æˆ·ç«¯                    VpnProxyServer              çœŸå®æœåŠ¡å™¨
  â”‚                            â”‚                          â”‚
  â”‚ SYN (seq=x)                â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                            â”‚ ForwardPacket()          â”‚
  â”‚                            â”‚ â”œâ”€ åˆ›å»ºTCP socket        â”‚
  â”‚                            â”‚ â”œâ”€ connect()             â”‚
  â”‚                            â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                            â”‚                          â”‚ SYN (seq=y)
  â”‚                            â”‚                          â”‚
  â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                            â”‚ SYN-ACK (seq=y, ack=x+1)  â”‚
  â”‚                            â”‚                          â”‚
  â”‚ SYN-ACK (seq=s, ack=x+1)   â”‚                          â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚                            â”‚                          â”‚
  â”‚ ACK (seq=x+1, ack=s+1)     â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
  â”‚                            â”‚ ForwardPacket()          â”‚
  â”‚                            â”‚ â”œâ”€ æ›´æ–°TCPçŠ¶æ€           â”‚
  â”‚                            â”‚ â””â”€ send() å‘é€æ•°æ®       â”‚
  â”‚                            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                            â”‚                          â”‚
  â”‚                            â”‚ StartTCPThread()          â”‚
  â”‚                            â”‚ â””â”€ recv() ç›‘å¬å“åº”        â”‚
  â”‚                            â”‚                          â”‚
```

---

## çº¿ç¨‹æ¨¡å‹

### çº¿ç¨‹æ¶æ„

```
ä¸»çº¿ç¨‹ (Main Thread)
  â”‚
  â”œâ”€ g_worker (WorkerLoop)
  â”‚   â””â”€ æ¥æ”¶å®¢æˆ·ç«¯æ•°æ®åŒ… (recvfrom)
  â”‚
  â””â”€ WorkerThreadPool
      â”‚
      â”œâ”€ forwardWorkerThread #1
      â”‚   â””â”€ å¤„ç†è½¬å‘ä»»åŠ¡ (å®¢æˆ·ç«¯â†’æœåŠ¡å™¨)
      â”‚
      â”œâ”€ forwardWorkerThread #2
      â”‚   â””â”€ å¤„ç†è½¬å‘ä»»åŠ¡
      â”‚
      â”œâ”€ ... (å¯é…ç½®æ•°é‡)
      â”‚
      â”œâ”€ responseWorkerThread #1
      â”‚   â””â”€ å¤„ç†å“åº”ä»»åŠ¡ (æœåŠ¡å™¨â†’å®¢æˆ·ç«¯)
      â”‚
      â”œâ”€ responseWorkerThread #2
      â”‚   â””â”€ å¤„ç†å“åº”ä»»åŠ¡
      â”‚
      â””â”€ ... (å¯é…ç½®æ•°é‡)

æ¯ä¸ªTCP/UDPè¿æ¥
  â”‚
  â”œâ”€ StartTCPThread (æ¯ä¸ªTCPè¿æ¥ä¸€ä¸ªçº¿ç¨‹)
  â”‚   â””â”€ recv() æ¥æ”¶æœåŠ¡å™¨å“åº”
  â”‚
  â””â”€ StartUDPThread (æ¯ä¸ªUDPè¿æ¥ä¸€ä¸ªçº¿ç¨‹)
      â””â”€ recvfrom() æ¥æ”¶æœåŠ¡å™¨å“åº”
```

### çº¿ç¨‹åŒæ­¥

- **åŸå­å˜é‡**: `g_running`, `g_sockFd`, ç»Ÿè®¡è®¡æ•°å™¨
- **äº’æ–¥é”**: `g_lastActivityMutex`, `g_clientsMutex`, `NATTable::mutex_`
- **æ¡ä»¶å˜é‡**: `ThreadSafeQueue::notEmpty_`, `ThreadSafeQueue::notFull_`

---

## å…³é”®æ•°æ®ç»“æ„

### PacketInfo (æ•°æ®åŒ…ä¿¡æ¯)
```cpp
struct PacketInfo {
    bool isValid;
    int addressFamily;        // AF_INET or AF_INET6
    uint8_t protocol;         // PROTOCOL_TCP/UDP/ICMP/ICMPV6
    std::string sourceIP;     // VPNè™šæ‹ŸIP
    std::string targetIP;     // ç›®æ ‡æœåŠ¡å™¨IP
    int sourcePort;
    int targetPort;
    uint8_t icmpv6Type;       // ICMP/ICMPv6ç±»å‹
    uint8_t icmpv6Code;       // ICMP/ICMPv6ä»£ç 
};
```

### NATConnection (NATè¿æ¥)
```cpp
struct NATConnection {
    sockaddr_in clientAddr;   // VPNå®¢æˆ·ç«¯åœ°å€
    std::string serverIP;     // ç›®æ ‡æœåŠ¡å™¨IP
    int serverPort;           // ç›®æ ‡æœåŠ¡å™¨ç«¯å£
    int forwardSocket;        // è½¬å‘socket fd
    uint8_t protocol;         // TCP/UDP
    int addressFamily;        // AF_INET/AF_INET6
    
    // TCPçŠ¶æ€æœº
    enum class TcpState {
        NONE, SYN_RECEIVED, ESTABLISHED, FIN_WAIT, CLOSED
    } tcpState;
    
    // TCPåºåˆ—å·ç®¡ç†
    uint32_t clientIsn;
    uint32_t serverIsn;
    uint32_t nextClientSeq;
    uint32_t nextServerSeq;
};
```

### ForwardTask (è½¬å‘ä»»åŠ¡)
```cpp
struct ForwardTask {
    PacketInfo packetInfo;    // æ•°æ®åŒ…ä¿¡æ¯
    uint8_t* data;            // æ•°æ®åŒ…å†…å®¹
    int dataSize;             // æ•°æ®åŒ…å¤§å°
    sockaddr_in originalPeer; // å®¢æˆ·ç«¯åœ°å€
    int tunnelFd;             // éš§é“æ–‡ä»¶æè¿°ç¬¦
};
```

### ResponseTask (å“åº”ä»»åŠ¡)
```cpp
struct ResponseTask {
    uint8_t* data;            // å“åº”æ•°æ®åŒ…
    int dataSize;             // æ•°æ®åŒ…å¤§å°
    sockaddr_in targetPeer;   // ç›®æ ‡å®¢æˆ·ç«¯åœ°å€
    int tunnelFd;             // éš§é“æ–‡ä»¶æè¿°ç¬¦
    uint8_t protocol;         // åè®®ç±»å‹
};
```

---

## åè®®æ”¯æŒ

### å·²å®ç°åè®®

| åè®® | åè®®å· | IPv4 | IPv6 | è½¬å‘çŠ¶æ€ | è¯´æ˜ |
|------|--------|------|------|----------|------|
| TCP  | 6      | âœ…   | âœ…   | âœ… å·²å®ç° | å®Œæ•´TCPçŠ¶æ€æœº |
| UDP  | 17     | âœ…   | âœ…   | âœ… å·²å®ç° | æ”¯æŒUDPé‡ä¼  |
| ICMP | 1      | âœ…   | âŒ   | âš ï¸ å·²è¯†åˆ« | æœªå®ç°è½¬å‘ |
| ICMPv6 | 58   | âŒ   | âœ…   | âš ï¸ å·²è¯†åˆ« | æœªå®ç°è½¬å‘ |

### TCP çŠ¶æ€æœº

```
NONE
  â”‚
  â”‚ æ”¶åˆ°SYN
  â–¼
SYN_RECEIVED
  â”‚
  â”‚ æ”¶åˆ°ACK (å®Œæˆä¸‰æ¬¡æ¡æ‰‹)
  â–¼
ESTABLISHED
  â”‚
  â”‚ æ”¶åˆ°FIN
  â–¼
FIN_WAIT
  â”‚
  â”‚ è¿æ¥å…³é—­
  â–¼
CLOSED
```

---

## å…³é”®è®¾è®¡å†³ç­–

### 1. å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
- **åŸå› **: é¿å…é˜»å¡ä¸»æ¥æ”¶å¾ªç¯
- **å®ç°**: `TaskQueueManager` + `WorkerThreadPool`
- **ä¼˜åŠ¿**: é«˜å¹¶å‘ã€å¯æ‰©å±•

### 2. NAT æ˜ å°„è¡¨
- **åŸå› **: VPNå®¢æˆ·ç«¯ä½¿ç”¨è™šæ‹ŸIPï¼Œéœ€è¦æ˜ å°„åˆ°çœŸå®æœåŠ¡å™¨
- **å®ç°**: `NATTable` ä½¿ç”¨ `std::map` + äº’æ–¥é”
- **Keyç”Ÿæˆ**: `clientIP:clientPort:serverIP:serverPort:protocol:addressFamily`

### 3. TCP çŠ¶æ€æœº
- **åŸå› **: éœ€è¦æ­£ç¡®ç®¡ç†TCPè¿æ¥çŠ¶æ€
- **å®ç°**: `NATConnection::TcpState` + åºåˆ—å·ç®¡ç†
- **åŠŸèƒ½**: æ”¯æŒSYN/SYN-ACK/ACK/FIN/RSTå¤„ç†

### 4. çº¿ç¨‹æ¨¡å‹
- **ä¸»çº¿ç¨‹**: æ¥æ”¶æ•°æ®åŒ…ï¼ˆWorkerLoopï¼‰
- **å·¥ä½œçº¿ç¨‹æ± **: å¤„ç†è½¬å‘/å“åº”ä»»åŠ¡
- **è¿æ¥çº¿ç¨‹**: æ¯ä¸ªTCP/UDPè¿æ¥ä¸€ä¸ªå“åº”çº¿ç¨‹

### 5. Socket è¿æ¥æ± 
- **åŸå› **: å¤ç”¨socketè¿æ¥ï¼Œæé«˜æ€§èƒ½
- **å®ç°**: `SocketConnectionPool` (åœ¨PacketForwarderä¸­)
- **Key**: `serverIP:serverPort:protocol:addressFamily`

---

## æ€§èƒ½ä¼˜åŒ–

1. **çº¿ç¨‹æ± **: é¿å…é¢‘ç¹åˆ›å»º/é”€æ¯çº¿ç¨‹
2. **Socketå¤ç”¨**: ç›¸åŒç›®æ ‡å¤ç”¨socketè¿æ¥
3. **å¼‚æ­¥å¤„ç†**: ä»»åŠ¡é˜Ÿåˆ—é¿å…é˜»å¡
4. **åŸå­å˜é‡**: ç»Ÿè®¡ä¿¡æ¯ä½¿ç”¨atomicï¼Œæ— é”è®¿é—®
5. **å†…å­˜ç®¡ç†**: ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆå’ŒRAII

---

## é”™è¯¯å¤„ç†

1. **Socketé”™è¯¯**: æ£€æŸ¥ `errno`ï¼Œè®°å½•æ—¥å¿—ï¼Œæ¸…ç†èµ„æº
2. **åè®®è§£æé”™è¯¯**: è¿”å› `isValid=false`ï¼Œé™é»˜ä¸¢å¼ƒ
3. **çº¿ç¨‹å¼‚å¸¸**: ä½¿ç”¨ `try-catch`ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨é€€å‡º
4. **èµ„æºæ¸…ç†**: `StopServer()` ç¡®ä¿æ‰€æœ‰èµ„æºæ­£ç¡®é‡Šæ”¾

---

## æ—¥å¿—ç³»ç»Ÿ

æ‰€æœ‰æ—¥å¿—ä½¿ç”¨ `ZHOUB` å‰ç¼€ï¼Œä¾¿äºè¿‡æ»¤ï¼š

- `ZHOUB server`: æœåŠ¡å™¨ä¸»æ—¥å¿—
- `ZHOUB [ä»£ç†æ¥æ”¶]`: æ¥æ”¶æ•°æ®åŒ…æ—¥å¿—
- `ZHOUB [STOP]`: æœåŠ¡å™¨åœæ­¢æ—¥å¿—
- `ZHOUB [æ€§èƒ½]`: æ€§èƒ½è¿½è¸ªæ—¥å¿—

---

## æ–‡ä»¶ç»“æ„

```
VpnProxyServer/entry/src/main/cpp/
â”œâ”€â”€ vpn_server.cpp              # ä¸»æœåŠ¡å™¨å…¥å£ï¼ŒNAPIæ¥å£
â”œâ”€â”€ vpn_server_globals.h        # å…¨å±€å˜é‡å£°æ˜
â”œâ”€â”€ protocol_handler.cpp/h       # åè®®è§£æå™¨ï¼ˆIPv4/IPv6ï¼‰
â”œâ”€â”€ packet_forwarder.cpp/h      # æ•°æ®åŒ…è½¬å‘å™¨
â”œâ”€â”€ packet_builder.cpp/h        # æ•°æ®åŒ…æ„å»ºå™¨
â”œâ”€â”€ nat_table.cpp/h             # NATæ˜ å°„è¡¨
â”œâ”€â”€ task_queue.cpp/h            # ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å™¨
â”œâ”€â”€ thread_safe_queue.h         # çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—
â”œâ”€â”€ worker_thread_pool.cpp/h    # å·¥ä½œçº¿ç¨‹æ± 
â”œâ”€â”€ udp_retransmit.cpp/h        # UDPé‡ä¼ ç®¡ç†å™¨
â”œâ”€â”€ network_diagnostics.cpp/h   # ç½‘ç»œè¯Šæ–­å·¥å…·
â”œâ”€â”€ thread_pool.cpp/h           # çº¿ç¨‹æ± ï¼ˆæ—§ç‰ˆï¼Œå·²å¼ƒç”¨ï¼‰
â””â”€â”€ CMakeLists.txt              # CMakeæ„å»ºé…ç½®
```

## ç¼–è¯‘é…ç½®

### CMakeLists.txt å…³é”®é…ç½®

```cmake
# æºæ–‡ä»¶åˆ—è¡¨
add_library(vpn_server SHARED
    vpn_server.cpp
    protocol_handler.cpp
    packet_forwarder.cpp
    packet_builder.cpp
    nat_table.cpp
    task_queue.cpp
    worker_thread_pool.cpp
    udp_retransmit.cpp
    network_diagnostics.cpp
)

# é“¾æ¥åº“
target_link_libraries(vpn_server
    PUBLIC
    hilog_ndk.z
    libace_ndk.z
    libuv.so
)
```

## NAPI æ¥å£

### å¯¼å‡ºå‡½æ•°

| å‡½æ•°å | å‚æ•° | è¿”å›å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `startServer` | `port: number` | `number` | å¯åŠ¨æœåŠ¡å™¨ï¼ˆ0=æˆåŠŸï¼Œ<0=å¤±è´¥ï¼‰ |
| `stopServer` | - | `number` | åœæ­¢æœåŠ¡å™¨ |
| `getStats` | - | `ServerStats` | è·å–æœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯ |
| `getClients` | - | `ClientInfo[]` | è·å–å®¢æˆ·ç«¯åˆ—è¡¨ |
| `getDataBuffer` | - | `string[]` | è·å–æ•°æ®ç¼“å†²åŒº |
| `testDNSQuery` | - | `string` | æµ‹è¯•DNSæŸ¥è¯¢ |
| `testNetworkConnectivity` | - | `string` | æµ‹è¯•ç½‘ç»œè¿é€šæ€§ |

### TypeScript ç±»å‹å®šä¹‰

```typescript
// types/libvpn_server/index.d.ts
export interface VpnServerModule {
    startServer(port: number): number;
    stopServer(): number;
    getStats(): ServerStats;
    getClients(): ClientInfo[];
    getDataBuffer(): string[];
    testDNSQuery(): string;
    testNetworkConnectivity(): string;
}
```

## é…ç½®å‚æ•°

### çº¿ç¨‹æ± é…ç½®

- **è½¬å‘çº¿ç¨‹æ•°**: é»˜è®¤ 4 ä¸ªï¼ˆå¯é…ç½®ï¼‰
- **å“åº”çº¿ç¨‹æ•°**: é»˜è®¤ 2 ä¸ªï¼ˆå¯é…ç½®ï¼‰
- **ä»»åŠ¡é˜Ÿåˆ—å®¹é‡**: 
  - è½¬å‘é˜Ÿåˆ—: 10000 ä¸ªä»»åŠ¡
  - å“åº”é˜Ÿåˆ—: 20000 ä¸ªä»»åŠ¡

### Socket é…ç½®

- **ç›‘å¬åœ°å€**: `0.0.0.0` (INADDR_ANY)
- **é»˜è®¤ç«¯å£**: `8888`
- **ç¼“å†²åŒºå¤§å°**: `2048` å­—èŠ‚
- **æ¥æ”¶è¶…æ—¶**: `100ms` (select timeout)

### NAT æ˜ å°„é…ç½®

- **è¶…æ—¶æ—¶é—´**: `300` ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
- **Key æ ¼å¼**: `clientIP:clientPort:serverIP:serverPort:protocol:addressFamily`

## æ€§èƒ½æŒ‡æ ‡

### ååé‡

- **æ•°æ®åŒ…å¤„ç†**: æ”¯æŒé«˜å¹¶å‘å¤„ç†
- **çº¿ç¨‹æ± **: å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†ä»»åŠ¡
- **Socketå¤ç”¨**: ç›¸åŒç›®æ ‡å¤ç”¨è¿æ¥

### å†…å­˜ä½¿ç”¨

- **ä»»åŠ¡é˜Ÿåˆ—**: æœ€å¤§ 30000 ä¸ªä»»åŠ¡ï¼ˆè½¬å‘+å“åº”ï¼‰
- **NATæ˜ å°„è¡¨**: åŠ¨æ€å¢é•¿ï¼Œæ— å›ºå®šä¸Šé™
- **æ•°æ®ç¼“å†²åŒº**: æœ€å¤§ 100 æ¡è®°å½•ï¼ˆUIæ˜¾ç¤ºï¼‰

## è°ƒè¯•å’Œæ—¥å¿—

### æ—¥å¿—çº§åˆ«

- `LOG_INFO`: ä¸€èˆ¬ä¿¡æ¯æ—¥å¿—
- `LOG_ERROR`: é”™è¯¯æ—¥å¿—
- `LOG_WARN`: è­¦å‘Šæ—¥å¿—

### æ—¥å¿—å‰ç¼€

æ‰€æœ‰æ—¥å¿—ä½¿ç”¨ `ZHOUB` å‰ç¼€ï¼Œä¾¿äºè¿‡æ»¤ï¼š

```bash
# è¿‡æ»¤æœåŠ¡å™¨æ—¥å¿—
adb logcat | grep "ZHOUB"

# è¿‡æ»¤ç‰¹å®šç±»å‹æ—¥å¿—
adb logcat | grep "ZHOUB.*ä»£ç†æ¥æ”¶"
adb logcat | grep "ZHOUB.*STOP"
adb logcat | grep "ZHOUB.*æ€§èƒ½"
```

### å…³é”®æ—¥å¿—ç‚¹

1. **æœåŠ¡å™¨å¯åŠ¨**: `ZHOUB ğŸš€ğŸš€ğŸš€ StartServer FUNCTION CALLED`
2. **æ•°æ®åŒ…æ¥æ”¶**: `ZHOUB [RX_CLIENT]`
3. **æ•°æ®åŒ…è½¬å‘**: `ZHOUB [ä»£ç†æ¥æ”¶]`
4. **æœåŠ¡å™¨åœæ­¢**: `ZHOUB [STOP]`
5. **æ€§èƒ½è¿½è¸ª**: `ZHOUB [æ€§èƒ½]`

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä½¿ç”¨å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼Ÿ

**A**: é¿å…é˜»å¡ä¸»æ¥æ”¶å¾ªç¯ï¼ˆWorkerLoopï¼‰ï¼Œæé«˜å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚ä¸»çº¿ç¨‹åªè´Ÿè´£æ¥æ”¶æ•°æ®åŒ…ï¼Œè½¬å‘å’Œå“åº”ç”±å·¥ä½œçº¿ç¨‹æ± å¤„ç†ã€‚

### Q2: NATæ˜ å°„è¡¨çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**A**: VPNå®¢æˆ·ç«¯ä½¿ç”¨è™šæ‹ŸIPåœ°å€ï¼Œéœ€è¦æ˜ å°„åˆ°çœŸå®çš„æœåŠ¡å™¨åœ°å€ã€‚NATè¡¨ç»´æŠ¤è¿™ä¸ªæ˜ å°„å…³ç³»ï¼Œç¡®ä¿å“åº”èƒ½æ­£ç¡®è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

### Q3: ä¸ºä»€ä¹ˆæ¯ä¸ªTCP/UDPè¿æ¥éœ€è¦ä¸€ä¸ªå“åº”çº¿ç¨‹ï¼Ÿ

**A**: æ¯ä¸ªè¿æ¥éœ€è¦æŒç»­ç›‘å¬æœåŠ¡å™¨å“åº”ï¼Œä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹å¯ä»¥é¿å…é˜»å¡ï¼Œæé«˜å¹¶å‘æ€§èƒ½ã€‚

### Q4: å¦‚ä½•å¤„ç†æœåŠ¡å™¨åœæ­¢ï¼Ÿ

**A**: 
1. è®¾ç½® `g_running = false`
2. å…³é—­ä¸»ç›‘å¬socket
3. å¼ºåˆ¶å…³é—­æ‰€æœ‰è½¬å‘socket
4. ç­‰å¾…æ‰€æœ‰çº¿ç¨‹é€€å‡º
5. æ¸…ç†æ‰€æœ‰èµ„æºï¼ˆNATè¡¨ã€ä»»åŠ¡é˜Ÿåˆ—ç­‰ï¼‰

### Q5: ä¸ºä»€ä¹ˆICMP/ICMPv6æœªå®ç°è½¬å‘ï¼Ÿ

**A**: å½“å‰ç‰ˆæœ¬å·²è¯†åˆ«ICMP/ICMPv6æ•°æ®åŒ…ï¼Œä½†è½¬å‘åŠŸèƒ½æœªå®ç°ã€‚å¦‚éœ€æ”¯æŒpingï¼Œéœ€è¦å®ç°ICMPè½¬å‘é€»è¾‘ã€‚

## æ‰©å±•å»ºè®®

### 1. å®ç°ICMPè½¬å‘

- åˆ›å»ºICMP socket
- è½¬å‘ICMPè¯·æ±‚åˆ°ç›®æ ‡æœåŠ¡å™¨
- æ¥æ”¶ICMPå“åº”å¹¶è¿”å›å®¢æˆ·ç«¯

### 2. æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨epoll/kqueueæ›¿ä»£selectï¼ˆLinux/macOSï¼‰
- å®ç°é›¶æ‹·è´æŠ€æœ¯
- ä¼˜åŒ–å†…å­˜åˆ†é…ï¼ˆä½¿ç”¨å†…å­˜æ± ï¼‰

### 3. åŠŸèƒ½å¢å¼º

- æ”¯æŒIPv6å®Œæ•´è½¬å‘
- å®ç°æµé‡ç»Ÿè®¡å’Œé™é€Ÿ
- æ·»åŠ è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ˆACLï¼‰
- æ”¯æŒåŠ å¯†éš§é“

## æ€»ç»“

VpnProxyServer æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€å¤šçº¿ç¨‹çš„VPNä»£ç†æœåŠ¡å™¨ï¼Œé‡‡ç”¨å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ã€NATæ˜ å°„ã€TCPçŠ¶æ€æœºç­‰è®¾è®¡ï¼Œæ”¯æŒå®Œæ•´çš„TCP/UDPåè®®è½¬å‘ã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚

### æ ¸å¿ƒä¼˜åŠ¿

1. **é«˜æ€§èƒ½**: å¤šçº¿ç¨‹å¹¶å‘å¤„ç†ï¼Œå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
2. **å¯æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
3. **å¥å£®æ€§**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œèµ„æºæ¸…ç†
4. **å¯ç»´æŠ¤**: æ¸…æ™°çš„ä»£ç ç»“æ„å’Œè¯¦ç»†çš„æ—¥å¿—

### æŠ€æœ¯æ ˆ

- **è¯­è¨€**: C++17
- **å¹³å°**: HarmonyOS
- **ç½‘ç»œ**: POSIX Socket API
- **å¹¶å‘**: std::thread, std::atomic, std::mutex
- **æ¥å£**: NAPI (Node.js API for Native Addons)
